hljs.initHighlightingOnLoad();autosize($("textarea"));var editor=$("#editor");var preview=$("#preview");function html_encode(a){return $("<div/>").text(a).html();
}function html_decode(a){return $("<div/>").html(a).text();}function readfile(a,b){if(!repo_idle){return;}repo_idle=false;repo.read("master",a,function(d,e){repo_idle=true;
b(d,e);});}function writefile(b,g,e,d){var a={author:{name:login_name,email:login_email},committer:{name:login_name,email:login_email},encode:d};if(!repo_idle){return;
}repo_idle=false;repo.write("master",b,g,".",a,function(h){repo_idle=true;e(h);});}function deletefile(a,b){if(!repo_idle){return;}repo_idle=false;repo.remove("master",a,function(d){repo_idle=true;
b(d);});}function readdir(a){if(!repo_idle){return;}repo_idle=false;repo.getTree("master?recursive=true",function(d,b){repo_idle=true;a(d,b);});}var login_name="PAPER";
var login_email;var repo=null;var repo_idle=false;var config={author:login_name,title:login_name,keywords:"",description:"",header:"PAPER"};var paper_list=new Array();
var paper_host;var f=function(){$(this).parent().removeClass("has-error");};$("#username").focus(f);$("#password").focus(f);$("#paper_title").focus(f);
$("#datetime_picker").datetimepicker({format:"YYYY-MM-DD HH:mm:ss",showTodayButton:true,showClear:true,});$("#upload_file").fileinput({language:"zh",showUpload:false,});
$("#dialog_login").modal({backdrop:"static",show:true,keyboard:false});var c=document.cookie;if(c&&c!=""){$("#username").val(c.split("=")[1].split(";")[0]);
}function show_error(b,a){console.log(a);$("#"+b).html('<div class="alert alert-danger" role="alert">'+a.error+" "+a.request.statusText+"</div>");}function edit_paper(a){readfile(a+".meta",function(b,d){if(b){return show_error("err_list",b);
}var e=jQuery.parseJSON(d);$("#editor").val(e.md);$("#paper_title").val(e.title);$("#paper_keywords").val(e.keywords);$("#paper_description").val(e.description);
autosize.update($("textarea"));$("#dialog_list").modal("hide");});}function delete_paper(a,b){$("#paper_"+a+" a").removeAttr("href");deletefile(b+".html",function(d){deletefile(b+".meta",function(e){update_index(function(g){if(d){return show_error("err_list",d);
}if(e){return show_error("err_list",e);}if(g){return show_error("err_list",g);}$("#paper_"+a).remove();});});});}$("#dialog_preview").on("show.bs.modal",function(){preview.html(marked(editor.val()));
});$("#dialog_publish").on("show.bs.modal",function(){$("#paper_datetime").val(moment(new Date()).format("YYYY-MM-DD HH:mm:ss"));$("#err_publish").empty();
$("#paper_mode").removeAttr("checked");});$("#dialog_upload").on("show.bs.modal",function(){var a=new Date();$("#upload_prefix").val(a.getFullYear()+"/"+(a.getMonth()+1)+"/");
$("#upload_file").fileinput("reset");$("#err_upload").empty();$("#btn_upload").attr("disabled","disabled");});$("#dialog_setting").on("show.bs.modal",function(){$("#err_setting").empty();
});function append_list(b,a,d){$("#paper_list").append('<li class="list-group-item" id="paper_'+b+'"><a href="'+paper_host+"/"+d+'.html" target="_blank">'+a+'</a><p class="pull-right"><a href="javascript:edit_paper(\''+d+'\')" title="edit">E</a> | <a href="javascript:delete_paper('+b+", '"+d+'\')" title="delete">D</a></p></li>');
}$("#dialog_list").on("show.bs.modal",function(){$("#paper_list").empty();$("#err_list").empty();$("#paper_list_search").val("");paper_list=[];readdir(function(a,b){if(a){return show_error("err_list",a);
}$(b).each(function(g,d){if(d.type=="tree"){return true;}if(d.path.substr(-5)!=".meta"){return true;}var h=d.path.substr(0,d.path.length-5);var e=h.substring(h.lastIndexOf("/")+1);
append_list(g,e,h);paper_list.push({path:h,name:e});});});});$("#dialog_help").on("show.bs.modal",function(){$.get("README.md",function(a){$("#help").html(marked(a));
});});$("#paper_list_search").keyup(function(){var a=$(this).val();$("#paper_list").empty();$(paper_list).each(function(d,b){if(b.name.toLowerCase().indexOf(a.toLowerCase())!=-1){append_list(d,b.name,b.path);
}});});$("#btn_login").click(function(){var h=$("#username").val();var b=$("#password").val();var d=true;if(h==""){d=false;$("#username").parent().addClass("has-error");
}if(b==""){d=false;$("#password").parent().addClass("has-error");}if(d==false){return;}var g=new Github({username:h,password:b,auth:"basic"});var e=function(i){$("#index_title").val(html_decode(config.title));
$("#index_author").val(html_decode(config.author));$("#index_keywords").val(html_decode(config.keywords));$("#index_description").val(html_decode(config.description));
$("#index_header").val(config.header);$("#index_disqus").val(config.disqus);autosize.update($("textarea"));$("#login_name").text(login_name).attr("href",paper_host).attr("target","_blank");
$("#btn_login").removeAttr("disabled");$("#dialog_login").modal("hide");repo_idle=true;editor.focus();if(i){$("#dialog_setting").modal("show");}};$(this).attr("disabled","disabled");
var a=g.getUser();a.show(null,function(j,i){if(j!=null){$("#btn_login").removeAttr("disabled");return show_error("err_login",j);}login_name=i.login;login_email=h;
paper_host="http://"+login_name+".github.io";var k=new Date();k.setFullYear(k.getFullYear()+10000);document.cookie="__paper_user="+h+";expires="+k.toUTCString();
repo=g.getRepo(login_name,login_name+".github.io");repo.show(function(m,l){if(m){a.createRepo({name:login_name+".github.io"},function(o,n){if(o!=null){$("#btn_login").removeAttr("disabled");
return show_error("err_login",o);}e(true);});}else{repo_idle=true;readfile("paper.json",function(n,p){var o=true;if(n==null){config=jQuery.parseJSON(p);
o=false;}e(o);});}});});});function create_rss_atom(h,b){var e=new Date();var a='<?xml version="1.0" encoding="UTF-8"?>';a+='<feed xmlns="http://www.w3.org/2005/Atom">';
a+="<title>";a+=config.title;a+="</title><id>";a+=paper_host;a+='</id><link rel="self" href="';a+=paper_host+'/atom.xml"></link><updated>';a+=e.toUTCString();
a+="</updated>";var g='<?xml version="1.0" encoding="UTF-8"?>';g+='<rss version="2.0"><channel><title>';g+=config.title;g+="</title><link>";g+=paper_host;
g+="</link><description>";g+=config.description;g+="</description><pubDate>";g+=e.toUTCString();g+="</pubDate>";$(h).each(function(k,d){e=moment(d.datetime).toDate();
var j=paper_host+"/"+d.path+".html";a+="<entry><title>";a+=d.title;a+="</title><id>";a+=j;a+='</id><link rel="self" href="';a+=j;a+='"></link><published>';
a+=e.toUTCString();a+="</published><updated>";a+=e.toUTCString();a+="</updated><author><name>";a+=config.author;a+='</name></author><summary type="text">';
a+=d.description;a+="</summary></entry>";g+="<item><title>";g+=d.title;g+="</title><link>";g+=j;g+="</link><description>";g+=d.description;g+="</description><pubDate>";
g+=e.toUTCString();g+="</pubDate></item>";});a+="</feed>";g+="</channel></rss>";writefile("rss.xml",g,function(d){writefile("atom.xml",a,function(i){if(d){return b(d);
}if(i){return b(i);}b();});});}function update_index(a){$.get("index.tpl",function(d){var b="";readdir(function(j,k){if(j!=null){return a(j);}var m=new Array();
var e=function(){m.sort(function(n,i){var p=moment(n.datetime).toDate();var o=moment(i.datetime).toDate();return p<o?1:-1;});$(m).each(function(o,n){b=b+'<a href="/'+n.path+'.html" class="list-group-item">'+n.title+"</a>\n";
});d=d.replace(/{{body}}/,b).replace(/{{title}}/,config.title).replace(/{{author}}/,config.author).replace(/{{keywords}}/,config.keywords).replace(/{{description}}/,config.description).replace(/{{header}}/,config.header);
writefile("index.html",d,function(i){if(i){return a(i);}create_rss_atom(m,a);});};var l=k.length;var g=0;var h=function(){if(g==l){e();return;}var i=k[g];
if(i.type=="tree"){g++;h();return;}var n=i.path.substr(-5);if(n==".meta"){readfile(i.path,function(p,q){var o=jQuery.parseJSON(q);if(o.mode=="publish"){m.push(o);
}g++;h();});}else{g++;h();}};h();});});}$("#btn_setting").click(function(){config.title=html_encode($("#index_title").val());config.author=html_encode($("#index_author").val());
config.keywords=html_encode($("#index_keywords").val());config.description=html_encode($("#index_description").val());config.header=$("#index_header").val();
config.disqus=$("#index_disqus").val();$(this).attr("disabled","disabled");writefile("paper.json",JSON.stringify(config),function(a){$("#btn_setting").removeAttr("disabled");
if(a){return show_error("err_setting",a);}$("#dialog_setting").modal("hide");});});var upload_data;var upload_encode=true;$("#upload_file").on("fileloaded",function(i,g,b,e,a){var k=new Date();
var j=k.getFullYear()+"/"+(k.getMonth()+1)+"/";upload_encode=true;$("#upload_prefix").val(j+g.name);if(typeof a.result==="string"){upload_data=a.result;
$("#btn_upload").removeAttr("disabled");}else{var h=new FileReader();h.onloadend=function(){upload_data=btoa(h.result);upload_encode=false;$("#btn_upload").removeAttr("disabled");
};h.readAsBinaryString(new Blob([a.result]));}});$("#upload_file").on("fileclear",function(){var a=new Date();$("#upload_prefix").val(a.getFullYear()+"/"+(a.getMonth()+1)+"/");
$("#err_upload").empty();$("#btn_upload").attr("disabled","disabled");});$("#upload_file").on("filebatchselected",function(){$("#err_upload").empty();});
$("#btn_upload").click(function(){$("#err_upload").empty();$(this).attr("disabled","disabled");var a=$("#upload_prefix").val();writefile(a,upload_data,function(b){$("#btn_upload").removeAttr("disabled");
if(b){return show_error("err_upload",b);}var d=paper_host+"/"+a;$("#err_upload").html('<a href="'+d+'" target="_blank">'+d+"</a>");},upload_encode);});
$("#btn_publish").click(function(){var e={};e.title=html_encode($("#paper_title").val());e.keywords=html_encode($("#paper_keywords").val());e.description=html_encode($("#paper_description").val());
e.datetime=$("#paper_datetime").val();e.md=editor.val();if($("#paper_mode").is(":checked")){e.mode="draft";}else{e.mode="publish";}if(e.title==""){$("#paper_title").parent().addClass("has-error");
return;}var a=marked(e.md);var g=moment(e.datetime).toDate();var b=g.getFullYear()+"/"+(g.getMonth()+1);e.path=b+"/"+e.title;$(this).attr("disabled","disabled");
$.get("paper.tpl",function(h){h=h.replace(/{{body}}/,a).replace(/{{title}}/,e.title).replace(/{{author}}/,config.author).replace(/{{disqus}}/,config.disqus).replace(/{{keywords}}/,e.keywords).replace(/{{description}}/,e.description).replace(/{{datetime}}/,e.datetime);
var d=function(i){update_index(function(j){$("#btn_publish").removeAttr("disabled");if(i){return show_error("err_publish",i);}if(j){return show_error("err_publish",j);
}$("#paper_title").val("");$("#paper_keywords").val("");$("#paper_description").val("");$("#editor").val("");$("#preview").html("");$("#dialog_publish").modal("hide");
autosize.update($("textarea"));});};writefile(e.path+".meta",JSON.stringify(e),function(i){if(e.mode=="publish"){writefile(e.path+".html",h,function(j){if(i){return d(i);
}return d(j);});}else{d(i);}});});});
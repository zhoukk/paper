hljs.initHighlightingOnLoad();autosize($("textarea"));var editor=$("#editor");var preview=$("#preview");function html_encode(a){return $("<div/>").text(a).html();
}function html_decode(a){return $("<div/>").html(a).text();}function readfile(a,b){if(!repo_idle){return;}repo_idle=false;repo.read("master",a,function(d,e){repo_idle=true;
b(d,e);});}function writefile(b,e,d){var a={author:{name:login_name,email:login_email},committer:{name:login_name,email:login_email},encode:true};if(!repo_idle){return;
}repo_idle=false;repo.write("master",b,e,".",a,function(g){repo_idle=true;d(g);});}function deletefile(a,b){if(!repo_idle){return;}repo_idle=false;repo.remove("master",a,function(d){repo_idle=true;
b(d);});}function readdir(a){if(!repo_idle){return;}repo_idle=false;repo.getTree("master?recursive=true",function(d,b){repo_idle=true;a(d,b);});}var login_name="PAPER";
var login_email;var repo=null;var repo_idle=false;var config={author:login_name,title:login_name,keywords:"",description:"",header:"PAPER"};var prefix="";
var paper_list=new Array();var f=function(){$(this).parent().removeClass("has-error");};$("#username").focus(f);$("#password").focus(f);$("#paper_title").focus(f);
$("#datetime_picker").datetimepicker({format:"YYYY-MM-DD HH:mm:ss",showTodayButton:true,showClear:true,});$("#dialog_login").modal({backdrop:"static",show:true,keyboard:false});
var c=document.cookie;if(c&&c!=""){$("#username").val(c.split("=")[1].split(";")[0]);}function show_error(b,a){console.log(a);$("#"+b).html('<div class="alert alert-danger" role="alert">'+a.error+" "+a.request.statusText+"</div>");
}function edit_paper(a){readfile(a+".meta",function(b,d){if(b){return show_error("err_list",b);}var e=jQuery.parseJSON(d);$("#editor").val(e.md);$("#paper_title").val(e.title);
$("#paper_keywords").val(e.keywords);$("#paper_description").val(e.description);autosize.update($("textarea"));$("#dialog_list").modal("hide");});}function delete_paper(a,b){$("#paper_"+a+" a").removeAttr("href");
deletefile(b+".html",function(d){deletefile(b+".meta",function(e){update_index(function(g){if(d){return show_error("err_list",d);}if(e){return show_error("err_list",e);
}if(g){return show_error("err_list",g);}$("#paper_"+a).remove();});});});}$("#dialog_preview").on("show.bs.modal",function(){preview.html(marked(editor.val()));
});$("#dialog_publish").on("show.bs.modal",function(){$("#paper_datetime").val(moment(new Date()).format("YYYY-MM-DD HH:mm:ss"));$("#err_publish").empty();
$("#paper_mode").removeAttr("checked");});$("#dialog_setting").on("show.bs.modal",function(){$("#err_setting").empty();});function append_list(b,a,d){$("#paper_list").append('<li class="list-group-item" id="paper_'+b+'"><a href="/'+d+'.html" target="_blank">'+a+'</a><p class="pull-right"><a href="javascript:edit_paper(\''+d+'\')" title="edit">E</a> | <a href="javascript:delete_paper('+b+", '"+d+'\')" title="delete">D</a></p></li>');
}$("#dialog_list").on("show.bs.modal",function(){$("#paper_list").empty();$("#err_list").empty();$("#paper_list_search").val("");paper_list=[];readdir(function(a,b){if(a){return show_error("err_list",a);
}$(b).each(function(g,d){if(d.type=="tree"){return true;}if(d.path.substr(-5)!=".meta"){return true;}var h=d.path.substr(0,d.path.length-5);var e=h.substring(h.lastIndexOf("/")+1);
append_list(g,e,h);paper_list.push({path:h,name:e});});});});$("#dialog_help").on("show.bs.modal",function(){$.get("README.md",function(a){$("#help").html(marked(a));
});});$("#paper_list_search").keyup(function(){var a=$(this).val();$("#paper_list").empty();$(paper_list).each(function(d,b){if(b.name.toLowerCase().indexOf(a.toLowerCase())!=-1){append_list(d,b.name,b.path);
}});});$("#btn_login").click(function(){var h=$("#username").val();var b=$("#password").val();var d=true;if(h==""){d=false;$("#username").parent().addClass("has-error");
}if(b==""){d=false;$("#password").parent().addClass("has-error");}if(d==false){return;}var g=new Github({username:h,password:b,auth:"basic"});var e=function(i){$("#index_title").val(html_decode(config.title));
$("#index_author").val(html_decode(config.author));$("#index_keywords").val(html_decode(config.keywords));$("#index_description").val(html_decode(config.description));
$("#index_header").val(config.header);$("#index_disqus").val(config.disqus);autosize.update($("textarea"));$("#login_name").text(login_name).attr("href","http://"+login_name+".github.io").attr("target","_blank");
$("#btn_login").removeAttr("disabled");$("#dialog_login").modal("hide");repo_idle=true;editor.focus();if(i){$("#dialog_setting").modal("show");}};$(this).attr("disabled","disabled");
var a=g.getUser();a.show(null,function(j,i){if(j!=null){$("#btn_login").removeAttr("disabled");return show_error("err_login",j);}login_name=i.login;login_email=h;
document.cookie="__paper_user="+h;repo=g.getRepo(login_name,login_name+".github.io");repo.show(function(l,k){if(l){a.createRepo({name:login_name+".github.io"},function(n,m){if(n!=null){$("#btn_login").removeAttr("disabled");
return show_error("err_login",n);}e(true);});}else{repo_idle=true;readfile("paper.json",function(m,o){var n=true;if(m==null){config=jQuery.parseJSON(o);
n=false;}e(n);});}});});});function create_rss_atom(i,e){var a="http://"+login_name+".github.io";var g=new Date();var b='<?xml version="1.0" encoding="UTF-8"?>';
b+='<feed xmlns="http://www.w3.org/2005/Atom">';b+="<title>";b+=config.title;b+="</title><id>";b+=a;b+='</id><link rel="self" href="';b+=a+'/atom.xml"></link><updated>';
b+=g.toUTCString();b+="</updated>";var h='<?xml version="1.0" encoding="UTF-8"?>';h+='<rss version="2.0"><channel><title>';h+=config.title;h+="</title><link>";
h+=a;h+="</link><description>";h+=config.description;h+="</description><pubDate>";h+=g.toUTCString();h+="</pubDate>";$(i).each(function(j,d){g=moment(d.datetime).toDate();
a="http://"+login_name+".github.io/"+d.path+".html";b+="<entry><title>";b+=d.title;b+="</title><id>";b+=a;b+='</id><link rel="self" href="';b+=a;b+='"></link><published>';
b+=g.toUTCString();b+="</published><updated>";b+=g.toUTCString();b+="</updated><author><name>";b+=config.author;b+='</name></author><summary type="text">';
b+=d.description;b+="</summary></entry>";h+="<item><title>";h+=d.title;h+="</title><link>";h+=a;h+="</link><description>";h+=d.description;h+="</description><pubDate>";
h+=g.toUTCString();h+="</pubDate></item>";});b+="</feed>";h+="</channel></rss>";writefile("rss.xml",h,function(d){writefile("atom.xml",b,function(j){if(d){return e(d);
}if(j){return e(j);}e();});});}function update_index(a){$.get("index.tpl",function(d){var b="";readdir(function(j,k){if(j!=null){return a(j);}var m=new Array();
var e=function(){m.sort(function(n,i){var p=moment(n.datetime).toDate();var o=moment(i.datetime).toDate();return p<o?1:-1;});$(m).each(function(o,n){b=b+'<a href="/'+n.path+'.html" class="list-group-item">'+n.title+"</a>\n";
});d=d.replace(/{{body}}/,b).replace(/{{title}}/,config.title).replace(/{{author}}/,config.author).replace(/{{keywords}}/,config.keywords).replace(/{{description}}/,config.description).replace(/{{header}}/,config.header);
writefile("index.html",d,function(i){if(i){return a(i);}create_rss_atom(m,a);});};var l=k.length;var g=0;var h=function(){if(g==l){e();return;}var i=k[g];
if(i.type=="tree"){g++;h();return;}var n=i.path.substr(-5);if(n==".meta"){readfile(i.path,function(p,q){var o=jQuery.parseJSON(q);if(o.mode=="publish"){m.push(o);
}g++;h();});}else{g++;h();}};h();});});}$("#btn_setting").click(function(){config.title=html_encode($("#index_title").val());config.author=html_encode($("#index_author").val());
config.keywords=html_encode($("#index_keywords").val());config.description=html_encode($("#index_description").val());config.header=$("#index_header").val();
config.disqus=$("#index_disqus").val();$(this).attr("disabled","disabled");writefile("paper.json",JSON.stringify(config),function(a){$("#btn_setting").removeAttr("disabled");
if(a){return show_error("err_setting",a);}$("#dialog_setting").modal("hide");});});$("#btn_publish").click(function(){var b={};b.title=html_encode($("#paper_title").val());
b.keywords=html_encode($("#paper_keywords").val());b.description=html_encode($("#paper_description").val());b.datetime=$("#paper_datetime").val();b.md=editor.val();
if($("#paper_mode").is(":checked")){b.mode="draft";}else{b.mode="publish";}if(b.title==""){$("#paper_title").parent().addClass("has-error");return;}var a=marked(b.md);
var e=moment(b.datetime).toDate();prefix=e.getFullYear()+"/"+(e.getMonth()+1);b.path=prefix+"/"+b.title;$(this).attr("disabled","disabled");$.get("paper.tpl",function(g){g=g.replace(/{{body}}/,a).replace(/{{title}}/,b.title).replace(/{{author}}/,config.author).replace(/{{disqus}}/,config.disqus).replace(/{{keywords}}/,b.keywords).replace(/{{description}}/,b.description).replace(/{{datetime}}/,b.datetime);
var d=function(h){update_index(function(i){$("#btn_publish").removeAttr("disabled");if(h){return show_error("err_publish",h);}if(i){return show_error("err_publish",i);
}$("#paper_title").val("");$("#paper_keywords").val("");$("#paper_description").val("");$("#editor").val("");$("#preview").html("");$("#dialog_publish").modal("hide");
autosize.update($("textarea"));});};writefile(b.path+".meta",JSON.stringify(b),function(h){if(b.mode=="publish"){writefile(b.path+".html",g,function(i){if(h){return d(h);
}return d(i);});}else{d(h);}});});});
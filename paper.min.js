hljs.initHighlightingOnLoad();autosize($("textarea"));var editor=$("#editor");var preview=$("#preview");function html_encode(a){return $("<div/>").text(a).html()}function html_decode(a){return $("<div/>").html(a).text()}function readfile(a,b){if(!repo_idle){return}repo_idle=false;repo.read("master",a,function(d,e){repo_idle=true;b(d,e)})}function writefile(b,f,e,d){var a={author:{name:login_name,email:login_email},committer:{name:login_name,email:login_email},encode:d};if(!repo_idle){return}repo_idle=false;repo.write("master",b,f,".",a,function(g){repo_idle=true;e(g)})}function deletefile(a,b){if(!repo_idle){return}repo_idle=false;repo.remove("master",a,function(d){repo_idle=true;b(d)})}function readdir(a){if(!repo_idle){return}repo_idle=false;repo.getTree("master?recursive=true",function(d,b){repo_idle=true;a(d,b)})}var login_name="PAPER";var login_email;var repo=null;var repo_idle=false;var config={author:login_name,title:login_name,keywords:"",description:"",header:"PAPER",index_cnt:10,list:[]};var paper_list=new Array();var paper_host;$("#username").focus(function(){$(this).parent().removeClass("has-error");$("#err_login").html("")});$("#password").focus(function(){$(this).parent().removeClass("has-error");$("#err_login").html("")});$("#paper_url").focus(function(){$(this).parent().removeClass("has-error")});$("#paper_title").focus(function(){$(this).parent().removeClass("has-error")});$("#datetime_picker").datetimepicker({format:"YYYY-MM-DD HH:mm:ss",showTodayButton:true,showClear:true}).on("dp.change",function(b){var a=$("#paper_url").val();var d=moment(b.oldDate).format("YYYY/MM/");if(a==""||a==d){$("#paper_url").val(moment(b.date).format("YYYY/MM/"))}});$("#upload_file").fileinput({language:"zh",showUpload:false});$("#dialog_login").modal({backdrop:"static",show:true,keyboard:false});$("#login_loading").hide();var c=document.cookie;if(c&&c!=""){$("#username").val(c.split("=")[1].split(";")[0])}function show_error(b,a){console.log(a);$("#"+b).html('<div class="alert alert-danger" role="alert">'+a.error+" "+a.request.statusText+"</div>")}function edit_paper(a){var b=paper_list[a];readfile(b,function(f,g){if(f){return show_error("err_list",f)}var e=g.indexOf("{");var d=g.indexOf("-->");if(e>=0&&d>=0){var h=jQuery.parseJSON(g.substring(e,d));$("#editor").val(h.md);$("#paper_title").val(h.title);$("#paper_url").val(h.url);$("#paper_keywords").val(h.keywords);$("#paper_description").val(h.description);$("#paper_datetime").val(h.datetime);autosize.update($("textarea"))}$("#dialog_list").modal("hide")})}function delete_paper(a){var b=paper_list[a];$("#paper_"+a+" a").removeAttr("href");$("#list_loading").show();deletefile(b,function(d){if(d){$("#list_loading").hide();return show_error("err_list",d)}$(config.list).each(function(f,e){if(e.url==b){config.list.splice(f,1);update_index(function(g){$("#list_loading").hide();if(g){return show_error("err_list",g)}$("#paper_"+a).remove()});return}})})}$("#dialog_preview").on("show.bs.modal",function(){preview.html(marked(editor.val()))});$("#dialog_publish").on("shown.bs.modal",function(){var a=$("#paper_datetime").val();if(a==""){a=new Date()}$("#paper_datetime").val(moment(a).format("YYYY-MM-DD HH:mm:ss"));if($("#paper_url").val()==""){$("#paper_url").val(moment(a).format("YYYY/MM/"));$("#paper_url").focus()}$("#err_publish").empty();$("#paper_mode").removeAttr("checked");$("#publish_loading").hide();var b=editor.val();if(b!=""){b=b.substring(0,b.indexOf("\n"));b=b.replace(/^#+|^\s+/,"");$("#paper_title").val(b)}});$("#dialog_upload").on("show.bs.modal",function(){$("#upload_prefix").val(moment(new Date()).format("YYYY/MM/"));$("#upload_file").fileinput("reset");$("#err_upload").empty();$("#btn_upload").attr("disabled","disabled");$("#upload_loading").hide()});$("#dialog_setting").on("show.bs.modal",function(){$("#err_setting").empty()});function append_list(a,b){$("#paper_list").append('<li class="list-group-item" id="paper_'+a+'"><a href="'+paper_host+"/"+b+'" target="_blank">'+b+'</a><p class="pull-right"><a href="javascript:edit_paper('+a+')" title="edit">E</a> | <a href="javascript:delete_paper('+a+')" title="delete">D</a></p></li>')}$("#dialog_list").on("show.bs.modal",function(){$("#paper_list").empty();$("#err_list").empty();$("#paper_list_search").val("");$("#list_loading").show();paper_list=[];readdir(function(b,d){$("#list_loading").hide();if(b){return show_error("err_list",b)}var a=0;$(d).each(function(f,e){if(e.type=="tree"){return true}if(e.path.substr(-5)!=".html"){return true}if(e.path=="index.html"||e.path=="archive.html"){return true}paper_list[a]=e.path;append_list(a,e.path);a=a+1})})});$("#dialog_help").on("show.bs.modal",function(){$.get("README.md",function(a){$("#help").html(marked(a))})});$("#paper_list_search").keyup(function(){var b=$(this).val();$("#paper_list").empty();var a=0;$(paper_list).each(function(e,d){if(d.toLowerCase().indexOf(b.toLowerCase())!=-1){append_list(a,d);a=a+1}})});$("#btn_login").click(function(){var h=$("#username").val();var b=$("#password").val();var d=true;if(h==""){d=false;$("#username").parent().addClass("has-error")}if(b==""){d=false;$("#password").parent().addClass("has-error")}if(d==false){return}var g=new Github({username:h,password:b,auth:"basic"});var e=function(f){$("#index_title").val(html_decode(config.title));$("#index_author").val(html_decode(config.author));$("#index_keywords").val(html_decode(config.keywords));$("#index_description").val(html_decode(config.description));$("#index_header").val(config.header);$("#index_cnt").val(config.index_cnt);$("#index_disqus").val(config.disqus);autosize.update($("textarea"));$("#login_name").text(login_name).attr("href",paper_host).attr("target","_blank");$("#btn_login").removeAttr("disabled");$("#login_loading").hide();$("#dialog_login").modal("hide");repo_idle=true;editor.focus();if(f){$("#dialog_setting").modal("show")}};$(this).attr("disabled","disabled");$("#login_loading").show();var a=g.getUser();a.show(null,function(i,f){if(i!=null){$("#btn_login").removeAttr("disabled");$("#login_loading").hide();$("#username").parent().addClass("has-error");$("#password").parent().addClass("has-error");return show_error("err_login",i)}login_name=f.login;login_email=h;paper_host="http://"+login_name+".github.io";var j=new Date();j.setFullYear(j.getFullYear()+10000);document.cookie="__paper_user="+h+";expires="+j.toUTCString();repo=g.getRepo(login_name,login_name+".github.io");repo.show(function(l,k){if(l){a.createRepo({name:login_name+".github.io"},function(n,m){if(n!=null){$("#btn_login").removeAttr("disabled");$("#login_loading").hide();return show_error("err_login",n)}e(true)})}else{repo_idle=true;readfile("index.html",function(o,q){var p=true;if(o==null){var n=q.indexOf("{");var m=q.indexOf("-->");if(n>=0&&m>=0){config=jQuery.parseJSON(q.substring(n,m));p=false}}e(p)})}})})});var upload_data;var upload_encode=true;$("#upload_file").on("fileloaded",function(g,e,b,d,a){var h=moment(new Date()).format("YYYY/MM/");upload_encode=true;$("#upload_prefix").val(h+e.name);if(typeof a.result==="string"){upload_data=a.result;$("#btn_upload").removeAttr("disabled")}else{var f=new FileReader();f.onloadend=function(){upload_data=btoa(f.result);upload_encode=false;$("#btn_upload").removeAttr("disabled")};f.readAsBinaryString(new Blob([a.result]))}});$("#upload_file").on("fileclear",function(){$("#upload_prefix").val(moment(new Date()).format("YYYY/MM/"));$("#err_upload").empty();$("#btn_upload").attr("disabled","disabled")});$("#upload_file").on("filebatchselected",function(){$("#err_upload").empty()});$("#btn_upload").click(function(){$("#err_upload").empty();$(this).attr("disabled","disabled");var a=$("#upload_prefix").val();$("#upload_loading").show();writefile(a,upload_data,function(b){$("#upload_loading").hide();$("#btn_upload").removeAttr("disabled");if(b){return show_error("err_upload",b)}var d=paper_host+"/"+a;$("#err_upload").html('<a href="'+d+'" target="_blank">'+d+"</a>")},upload_encode)});function update_archive(d,b){var a=function(f){var e="<li>"+d.datetime+' <a href="'+d.url+'">'+d.title+"</a></li>";f=f.replace(/<ol reversed>/,"<ol reversed>\n"+e);writefile("archive.html",f,function(g){b(g)})};readfile("archive.html",function(e,f){if(e){$.get("archive.tpl",function(g){a(g)})}else{a(f)}})}function update_index(a){$.get("index.tpl",function(d){var b="";$(config.list).each(function(f,e){b=b+'<a href="'+e.url+'" class="list-group-item">'+e.title+"</a>\n"});d=d.replace(/{{body}}/,b).replace(/{{title}}/,config.title).replace(/{{author}}/,config.author).replace(/{{keywords}}/,config.keywords).replace(/{{description}}/,config.description).replace(/{{header}}/,config.header);d="<!--"+JSON.stringify(config)+"-->\n"+d;writefile("index.html",d,function(e){a(e)})})}function create_paper(d,b){var a=marked(d.md);$.get("paper.tpl",function(e){e=e.replace(/{{body}}/,a).replace(/{{title}}/,d.title).replace(/{{author}}/,config.author).replace(/{{disqus}}/,config.disqus).replace(/{{keywords}}/,d.keywords).replace(/{{description}}/,d.description).replace(/{{datetime}}/,d.datetime);e="<!--"+JSON.stringify(d)+"-->\n"+e;writefile(d.url,e,function(f){b(f)})})}$("#btn_setting").click(function(){config.title=html_encode($("#index_title").val());config.author=html_encode($("#index_author").val());config.keywords=html_encode($("#index_keywords").val());config.description=html_encode($("#index_description").val());config.header=$("#index_header").val();config.index_cnt=$("#index_cnt").val();config.disqus=$("#index_disqus").val();$(this).attr("disabled","disabled");$("#setting_loading").show();update_index(function(a){$("#btn_setting").removeAttr("disabled");$("#setting_loading").hide();if(a){return show_error("err_setting",a)}$("#dialog_setting").modal("hide")})});$("#btn_publish").click(function(){var b={};b.title=html_encode($("#paper_title").val());b.url=$("#paper_url").val();b.keywords=html_encode($("#paper_keywords").val());b.description=html_encode($("#paper_description").val());b.datetime=$("#paper_datetime").val();b.md=editor.val();if($("#paper_mode").is(":checked")){b.mode="draft"}else{b.mode="publish"}var a=moment(b.datetime).format("YYYY/MM/");if(b.url==""||b.url==a){$("#paper_url").parent().addClass("has-error");return}if(b.title==""){$("#paper_title").parent().addClass("has-error");return}if(b.url.substr(-5)!=".html"){b.url=b.url+".html"}var d=function(){$("#paper_title").val("");$("#paper_url").val("");$("#paper_keywords").val("");$("#paper_description").val("");$("#paper_datetime").val("");$("#editor").val("");$("#preview").html("");$("#dialog_publish").modal("hide");autosize.update($("textarea"))};$(this).attr("disabled","disabled");$("#publish_loading").show();create_paper(b,function(e){if(e){$("#btn_publish").removeAttr("disabled");$("#publish_loading").hide();return show_error("err_publish",e)}if(b.mode=="draft"){$("#btn_publish").removeAttr("disabled");$("#publish_loading").hide();d();return}while(config.list.length>=config.index_cnt){config.list.pop()}config.list.unshift({url:b.url,title:b.title});update_index(function(f){if(f){$("#btn_publish").removeAttr("disabled");$("#publish_loading").hide();return show_error("err_publish",f)}update_archive(b,function(g){$("#btn_publish").removeAttr("disabled");$("#publish_loading").hide();if(g){return show_error("err_publish",g)}d()})})})});